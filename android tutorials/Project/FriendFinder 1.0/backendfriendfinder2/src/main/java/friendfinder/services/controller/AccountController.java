package friendfinder.services.controller;

import friendfinder.domain.Account;
import friendfinder.domain.User;
import friendfinder.persistence.AccountRepository;
import friendfinder.persistence.UserRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.*;

import static org.springframework.web.bind.annotation.RequestMethod.*;

/**
 * Created by grace on 23/06/17.
 */
@RestController    // This means that this class is a Controller
@RequestMapping(path="/account") // This means URL's start with /account (after Application path)
public class AccountController {
    @Autowired // This means to get the bean called userRepository
    // Which is auto-generated by Spring, we will use it to handle the data
    private AccountRepository accountRepository;

    @GetMapping(path="/all")
    public Iterable<Account> getAllAccounts() {
        // This returns a JSON with the accounts
        System.out.println("Getting all accounts");

        return accountRepository.findAll();
    }

    @GetMapping(path="/getByEmail")
    public String getAccount (@RequestParam(value = "email") String email) {
        System.out.println("Getting the account by email");
        String accountId = "";
        try {
            Account serchedAccount = accountRepository.findByEmail(email);
            accountId = String.valueOf(serchedAccount.getAccountId());
        } catch (Exception ex) {
            System.out.println("Error getting the Account: " + ex.toString());
        }
        return "The account id is: " + accountId;
    }

    @PostMapping
    public String postAccount (@RequestBody Account entity) {
        // @ResponseBody means the returned String is the response, not a view name
        // @RequestParam means it is a parameter from the GET or POST request
        System.out.println("Creating an account");

        String accountId = "";
        try {
            User usr = new User(entity);
            entity.setUser(usr);
            accountRepository.save(entity);
            accountId = String.valueOf(entity.getAccountId());
        } catch (Exception ex) {
            ex.printStackTrace();
            return "Error creating the account: " + ex.toString();
        }
        return "Account successfully created with id = " + accountId;
    }

    @PutMapping(value = "/{accountId}")
    public Account updateAccount (@PathVariable(value = "accountId") Integer accountId,
                                 @RequestBody Account entity) {
        System.out.println("Updating an account");
        try {
            Account entityBefore = accountRepository.findByAccountId(accountId);
            entity.setAccountId(accountId);
            entity.setCreatedAt(entityBefore.getCreatedAt());
            accountRepository.save(entity);
        } catch (Exception ex) {
            ex.printStackTrace();
            System.out.println("Error updating the Account: " + ex.toString());
        }
        return entity;
    }

    @DeleteMapping(value = "/{accountId}")
    public void deleteAccount (@PathVariable(value = "accountId") Integer accountId) {
        System.out.println("Deleting an account");
        try {
            Account deleteAccount = accountRepository.findByAccountId(accountId);
            accountRepository.delete(deleteAccount);
        } catch (Exception ex) {
            System.out.println("Error deleting the Account: " + ex.toString());
        }
    }
}
